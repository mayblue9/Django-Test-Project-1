<html>
<head>
	<!-- Javascript -->
	<script src="{{ STATIC_URL }}js/d3/d3.js" type='text/javascript'></script>
	<script src="{{ STATIC_URL }}js/d3/d3.layout.js" type='text/javascript'> </script>
	<script src="{{ STATIC_URL }}js/jquery-ui-1.8.17.custom/js/jquery-1.7.1.min.js" type='text/javascript'></script>	
	<script src="{{ STATIC_URL }}js/jquery-ui-1.8.17.custom/js/jquery-ui-1.8.17.custom.min.js" type='text/javascript'></script>
		<!-- Files to correct jQuery's handling of svg dom objects -->
	<script src="{{ STATIC_URL }}js/jquery.svg/jquery.svg.js" type='text/javascript'></script>
	<script src="{{ STATIC_URL }}js/jquery.svg/jquery.svgdom.js" type='text/javascript'></script>
	<script>
	// Define card sizes
	var card_width = 100;
	var card_height = 60;
	var dropHEIGHT = 500;
	var dropWIDTH = dropHEIGHT * 2;
	var cardSizeMulti = 0.8; // how much smaller are the cards on the svg
	var cardRoundedFactor = 0.02;
	var card_vis;
	var max_text_size = 40; // The longest name allowed for a card

	// Definines the placement of queued cards
	function getNewCardOffset() {
		'use strict';
		var newOffset = $("#cards_container").offset();
		newOffset.top += 5;
		newOffset.left += 10;
		return newOffset;
	}

	/*
	 * Resize functions are un-tested
	 */
	function resizeCards(p) {
		'use strict';
		card_width = card_width * p;
		card_height = card_height * p;
		// draggable
		$(".draggable").attr("width", card_width).attr("height", card_height);
		update_cards();
	}
	
	function resizeDropArea(p) {
		dropHEIGHT = dropHEIGHT*p;
		dropWIDTH = dropWIDTH*p;
		// card_visualisation
		$("#card_visualisation").attr("width", dropWIDTH).attr("height", dropHEIGHT);
		update_cards();
	}
	
	// Get all JSON data for current session into table
	function updateSessionTable(data) {
		// Use the data already collected for svg
		// format: {id, x, y, name} as {id, value1, value2, value3}
		var str = "<tr>";
		//str += "<th>Card Name</th><th>x coord</th><th>y coord</th>";
		str += "<th>id</th><th>Card Name</th><th>x coord</th><th>y coord</th>";
		str += "</tr>";
		$.each(data, function(key,val) {
			// console.log(val.value3 + ": " + (val.value1) + ", " + (val.value2));
			str += "<tr><td>" + val.id + "</td><td>" + val.value3 + "</td><td>" + (val.value1) + "</td><td>" + (val.value2)+ "</td></tr>";
		})
		$("#dropped_cards").html(str);
	}
	
	// Namespace protected functions
	$(function() {
		// Initialize the drop area
		$( "#droppable" ).droppable();	
		
		// Determine where it was clicked
		/**
		$( "#droppable" ).bind( "dblclick", function(event) {
			var toffset = $(this).offset();
			var w = $(this).width();
			var h = $(this).height();
			var w_rel = (event.pageX - toffset.left)/(w);
			var h_rel = (event.pageY - toffset.top)/(h);
			//alert(w_rel +'%, '+ h_rel + '%');
			
			// send coords as well as size being used for card
			var card_h = card_height/h;
			var card_w = card_width/w;
			var session_id = $("#session_select :selected").val();
			console.log("Recalling card")
     		$.getJSON("/seventools/cardsession/recallcard/", { height: card_h, width: card_w, x_coord: w_rel, y_coord: h_rel, session_id: session_id }, 
     		function(data) {
     			// refresh view
     			console.log("Card recalled");     			console.log(data);
     			console.log(data.deleted_name);
     			if(data.deleted_name !== ""){
	     			update_cards ();
	     			addCardToQueue(data.deleted_name);
     			}
     		});
     		console.log("Finished recalling card")
		})
		//**/
		
		// Move a card from the queue into the drop area
		$( "#droppable" ).bind( "drop", function(event, ui) {

			console.log("card was dropped on canvas");
			
			// Determine position of dropped card on drop area
			var toffset = $(this).offset();
			var w = $(this).width();
			var h = $(this).height();
			var w_rel = (ui.draggable.offset().left - toffset.left)/(w);
			var h_rel = (ui.draggable.offset().top - toffset.top)/(h);
			
			// Add and remove relevant classes
			ui.draggable.removeClass("undropped_card");
			ui.draggable.addClass("dropped_card");
			
			// Move the card positions to fill gap left by dropped card
			var spacing = 0;
			$("#cards_container").children().each( function(index, domE){				
				if( $(domE).hasClass("undropped_card")){
					// Move each card down to fill space left by dropped card
					var o_offset = $(domE).offset();
					var ntop = o_offset.top - spacing;
					$(domE).offset({ top: ntop, left: o_offset.left})
				} else {
					// Track space left by dropped card
					spacing += $(domE).outerHeight(true);
				}
			})
    		
     		// Add card to database
 			console.log("adding card via xhr");
     		var card_name = ui.draggable.text();
     		var session_id = $("#session_select :selected").val();
     		$.get("/seventools/cardsession/addcard/", { name: card_name, session_id: session_id, x_coord: w_rel, y_coord: h_rel },
     		function(data){
     			console.log(data);
     			if(data !== "Card added"){
     				alert(data);
     			}     			
     			
     			// Wait for card to be added before updating
				update_cards ();
     		});
     		
			// Remove card from the queue
			ui.draggable.remove();

		});
	})
	
	// Create a new card by passing the new name
	function addCardToQueue(card){
		console.log('new card name: ' + card);

		// Position the new card
		var spacing = $(".draggable").outerHeight(true); // spcaing between cards in px, same for all cards
		console.log("n_undropped = " + $(".undropped_card").length)
		
		// Move all the cards down
		$(".undropped_card").each(function(){
			var o_offset = $(this).offset();
			$(this).offset({ top: o_offset.top + spacing, left: o_offset.left})
		})
		
		// Create new card and prepend to list
		$('<div class="draggable ui-widget-content undropped_card shadow">' + card + '</div>').prependTo($('#cards_container'))
																						.draggable({ revert: "invalid" })
																						.offset(getNewCardOffset());
	}
	
	// Functions to call once when doc ready
	$(document).ready(function(){
		// Create a new card with the form
		$("#name_input").submit(function(){
			var card = $('#new_card').val();
			addCardToQueue(card);		
			$(this).find(':text').val(''); // reset form to avoid duplicates
		})
		$("#session_select :input").change(function(){
			update_cards ();
		})

		/* 
		 * card_visualisation
		 */
		// variables
		var w = 1000,
			h = 500;
		
		// An svg element, top-lft origin
		card_vis = d3.select("#droppable").append("svg") // this is an svg
			.attr("width",w)
			.attr("height",h)
			.style("padding-right","30px")
		
		// Add a g element to contain the cards and allow relatove movement
		body = card_vis.append("g")
			.attr("transform", "translate(0,0)");
		
		/** Come back to this
		var brush = d3.svg.brush()
			.on("brushstart", brushstart)
			.on("brush", brush)
			.on("brushend", brushend);
		//**/
				
		// Call the update function		
		update_cards();
	})
	
	// Redraw cards
	function update_cards() {
		// Collect data
		var all_card_data = cardPositionData();
		
		// Add a container for each card
		var card_disp = body.selectAll("g")
		    .data(all_card_data, function(d) { return d.value3; }); // sort by output order from django data model
		   
		// Identify the entering nodes with their own variable
	   	var card_disp_enter = card_disp.enter().append("g")
	      	.attr("class","svg_card")
			.attr("transform", function(d) { return "translate(" + d.value1 + "," + d.value2 + ")"; }) // transform to x and y for card
			.attr("font-size",card_width*cardSizeMulti/9)
			.on("click", svgCardClick)
			.on("dblclick", function(d){ changeCardName(d.value3, this)})
	
		// Add rectangle
		card_disp_enter.append("rect")
			.attr("x", 1)
	      	.attr("y",1)
			.attr("width", card_width*cardSizeMulti)
			.attr("height", card_height*cardSizeMulti)
			.attr("rx", card_width*cardRoundedFactor)
			.attr("ry", card_height*cardRoundedFactor)	
			.call(d3.behavior.drag()
	            .on("drag", drag)
	         );				
			
		
		// Add and position text
		// 3 text elements are used to wrap 3 lines
		var nlines = 1;
		card_disp_enter.append("text")
			.attr("x", card_width*cardSizeMulti/2)
			.attr("text-anchor", "middle")
			.text(function (d) { text = splitString(d.value3, 12); nlines = text.length; return text[0]; })
			.attr("y", card_height*cardSizeMulti/2 - 5*(nlines-1))
		
		// Subsequent text boxes can return array values that don't existi with no error
		card_disp_enter.append("text")
			.attr("x", card_width*cardSizeMulti/2)
			.attr("text-anchor", "middle")
			.text(function (d) { text = splitString(d.value3, 12); nlines = text.length; return text[1]; })
			.attr("y", card_height*cardSizeMulti/2 + 15  - 5*(nlines-1))
			
		card_disp_enter.append("text")
			.attr("x", card_width*cardSizeMulti/2)
			.attr("text-anchor", "middle")
			.text(function (d) { text = splitString(d.value3, 12); nlines = text.length; return text[2]; })			
			.attr("y", card_height*cardSizeMulti/2 + 30 - 5*(nlines-1))
			
		// Transition and exit
		card_disp.transition().duration(0)
			.attr("transform", function(d) { return "translate(" + d.value1 + "," + d.value2 + ")"; }); // transform to x and y for card
		
		// Not getting red of old cards
		card_disp.exit()
			.transition().duration(500)
			.attr("transform", function(d) { return "translate(" + -card_width*cardSizeMulti + "," + d.value2 + ")"; })
				.remove ();
		
		// Update table display too
		updateSessionTable(all_card_data);
	}
	
	// Check if this has class
	function svgCardClick () {
		var test_class = 'clicked_svg_card';

		if ($(this).hasClass(test_class)) {
			// Split class data
			console.log(this);
			$(this).removeClass(test_class);
			console.log(this);
			console.log("Card de-selected");
		} else {
			console.log(this);
			$(this).addClass(test_class);
			console.log(this);
			console.log("Card selected");
		}		
	}
	
	// Change the name of the card
	function changeCardName(cname, ccard) {
		// Change to provide validation; no empty name (no action taken)
		var name = prompt("Please enter a new name",cname);
		console.log("selection test #09876")
		console.log(ccard);
		console.log($(ccard).find("text"));
		console.log($(ccard).find("text")[0]);
		console.log($(ccard).find("text")[0].text);
		if (name!=null && name!="")
		{
			// change name
			text = splitString(name, 12);
			nlines = text.length;
			$($(ccard).find("text")[0]).text(text[0]);
			$($(ccard).find("text")[1]).text(text[1]);
			$($(ccard).find("text")[2]).text(text[2]);
		} else {
			// Nothing
		}
	}
	
	// Function to call on svg drag
	// PROBLEM: only works when drag is started horizontal left
	// CAN WE ADD TO SELECTION?
	function drag(){
		var test_class = 'clicked_svg_card';
		if ($(this).parent().hasClass(test_class)) {
	        console.log("drag");
	        // Move rect
	        var dragTarget = d3.select(this);
	        dragTarget.attr("x", function(){return d3.event.dx + parseInt(dragTarget.attr("x"))});
			dragTarget.attr("y", function(){return d3.event.dy + parseInt(dragTarget.attr("y"))});
	        
	        // Move text
	        dragTarget = d3.selectAll($(this).parent().find("text").get());

	        // Fix this so the text position changes for each separately
	        // Probably need to get data from each element separately
	        dragTarget
	        	.attr("x", function(){return d3.event.dx + parseInt(dragTarget.attr("x"))})
	        	.attr("y", function(){return d3.event.dy + parseInt(dragTarget.attr("y"))});
		} else {
			console.log("not draggable without selecting first");
		}
    }	
	
	// Card position data
	function cardPositionData () {
		// Intialize variables
		var session_id = $("#session_select :selected").val();
		var dataset = [];
		
		// Define function to run on completion
		function getCardDataD3(data){	
			var card;
			$.each(data, function(key,val) {
				card = val.fields;
				var ncard = {
					id: key,
					value1: (card.x_coord * dropWIDTH),
					value2: (card.y_coord * dropHEIGHT),
					value3: card.name
				}
				dataset.push (ncard);
			})
		}
		
		// Collect data synchronously so it can be processed by D3 upon return
		$.ajax({
		    type: 'GET',
		    url: "/seventools/cardsession/json/",
		    dataType: 'json',
		    success: function(data){getCardDataD3(data)},
		    data: { id: session_id},
		    async: false
		});
	
		//console.log("Number of cards to be plotted: " + dataset.length);
		//console.log(dataset);
		return dataset;
	}
	
	// Split string into equal sized parts
	// Maxlength denotes the # chars after which a new word should not be started
	function splitString(s, maxlength){
		// The length of the string
		var s_array = new Array();
		var total_length = s.split("").length;
		if(total_length < maxlength){
			s_array[0] = (s);
			return s_array;
		} else {
			// return array
			var c_string = "";
			var c_length = 0;
			var array_l = 0;
			$(s.split(" ")).each(function(){
				c_length += this.split("").length;
				c_string += this + " ";
				if(c_string.split("").length > maxlength){
					s_array[array_l] = $.trim(c_string);
					c_string = "";
					c_length = 0;
					array_l++;
				}
			})
			if(c_string.split("").length > 0){
				s_array[array_l] = c_string;				
			}
			return s_array;
		}
	}
		
	</script>
	<!-- Styling -->
	<style>
	.draggable { 
		background-color: #F8F5E1; 
		width: 100px; 
		height: 60px; 
		padding: 0.5em; 
		position:fixed; 
		margin: 10px 10px 10px 10px;
		border: 1px solid black;
		z-index:100;
	}
	#droppable { padding: 0.5em; float: left; margin: 10px 10px 10px 10px;
		border: 1px solid black;
  		position:relative;
  		z-index:50;
	}
	#card_entry { float: left; }
	#dropped_cards th { border: 1px solid black;}
	#dropped_cards td { border: 1px solid black;}
	svg {
		border: 1px solid #000;
		z-index:60;
	}
	#card_visualisation {
		position:relative;
		z-index:1;
	}	
	.shadow {
	  -moz-box-shadow:    3px 3px 5px black;
	  -webkit-box-shadow: 3px 3px 5px black;
	  box-shadow:         3px 3px 5px black;
	}
	.draggable {
		font-family: "Courier New", Courier, monospace;
	}
	.svg_card{
		opacity:0.8;
		font-family: "Courier New", Courier, monospace;
	}
	.svg_card rect {
		fill: #F8F5E1;
		stroke: black;
	}
	.clicked_svg_card rect {
		fill: #FF0000;
		opacity:0.6;
	}
	.selecting rect {
	  fill-opacity: .2;
	}
	
	.selecting rect.selected {
	  stroke: #f00;
	}
	</style>
</head>
<body>
	<div id="card_entry">
		<h1>Create Cards</h1>
		
		<form id="name_input" action="javascript: var a=1;">
			New card: <input type="text" id="new_card" maxlength = "40" name="newcardname" /><br />
			<input type="submit" value="Submit" />
		</form>
		
		<div id="cards_container"></div>
	</div>
	
	<div id="droppable"></div>
	<h2>Select Session</h2>
	<form id = "session_select">
		<select>
  		{% for session in sessions %}
	  		<option value="{{ session.id }}">{{ session.name }}</option>
		{% endfor %}
		</select>
	</form>
	<table id="dropped_cards"></table>
	<button onclick="update_cards()">Update SVG</button>
	
</body>
	
</html>